<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSL 고교선택적성검사 결과</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="js/dataProcessor.js"></script>
    <script src="js/data.js"></script>
    <script src="js/highSchoolRecommendation.js"></script>
    <script src="js/universityStrategy.js"></script>
    <script src="js/admissionRoadmap.js"></script>
    <script src="js/academicImprovement.js"></script>
    <script src="js/overallAssessment.js"></script>
    <link rel="stylesheet" href="css/navy-theme.css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        h1, h2 {
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #5A3A22;
            padding-bottom: 10px;
        }

        h2 {
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 5px solid #5A3A22;
            padding-left: 10px;
        }

        #loading, #error {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }

        #error {
            color: #dc3545;
            font-weight: bold;
        }

        .student-info {
            display: flex;
            flex-wrap: wrap;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .student-info-item {
            flex: 1 1 200px;
            margin: 10px;
            padding: 5px;
        }

        .student-info-item strong {
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }

        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
            height: 400px;
            position: relative;
        }

        .radar-chart-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
            height: 600px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .normal-dist-charts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .normal-chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            height: 300px;
            position: relative;
        }

        .scale-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .scale-data-table th, .scale-data-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .scale-data-table th {
            background-color: #5A3A22;
            color: white;
            font-weight: bold;
        }

        .scale-data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .scale-data-table tr:hover {
            background-color: #f1f1f1;
        }

        @media (max-width: 768px) {
            .normal-dist-charts {
                grid-template-columns: 1fr;
            }
            .student-info-item {
                flex: 1 1 100%;
            }
            .scale-data-table {
                font-size: 14px;
            }
            .scale-data-table th, .scale-data-table td {
                padding: 8px;
            }
            .radar-chart-container {
                height: 400px; /* 모바일에서 더 적합한 높이로 조정 */
                padding: 10px;
            }
            .chart-container {
                height: 350px; /* 다른 차트도 모바일에 맞게 조정 */
            }
        }
    </style>
</head>
<body>
    <h1>SSL 고교선택적성검사 결과</h1>
    
    <div id="loading">데이터를 불러오는 중...</div>
    <div id="error" style="display: none;"></div>
    
    <div id="report-content" style="display: none;">
        <!-- 학생 정보 섹션 -->
        <div class="student-info">
            <div class="student-info-item">
                <strong>학생 ID:</strong> <span id="studentId"></span>
            </div>
            <div class="student-info-item">
                <strong>학생명:</strong> <span id="studentName"></span>
            </div>
            <div class="student-info-item">
                <strong>출신학교:</strong> <span id="studentSchool"></span>
            </div>
            <div class="student-info-item">
                <strong>검사일:</strong> <span id="testDate"></span>
            </div>
        </div>
        
        <!-- 1. 고교적성 6척도 절대점수 프로파일 -->
        <h2>1. 고교선택적성 6척도 결과</h2>
        <div class="radar-chart-container">
            <canvas id="radarChart"></canvas>
        </div>
        
        <!-- 2. 고교적성 6척도 점수 요약 -->
        <h2>2. 고교선택적성 6척도 점수</h2>
        <table class="scale-data-table">
            <thead>
                <tr>
                    <th>척도</th>
                    <th>총점<br>(200점 만점)</th>
                    <th>평균점수<br>(5점 만점)</th>
                    <th>Z점수</th>
                    <th>백분위</th>
                    <th>상위</th>
                </tr>
            </thead>
            <tbody id="scaleTableBody">
                <!-- 동적으로 채워짐 -->
            </tbody>
        </table>
        
        <!-- 3. 고교적성 6척도 상대점수 -->
        <h2>3. 고교선택적성 6척도 상대점수</h2>
        <div class="normal-dist-charts">
            <div class="normal-chart-container">
                <canvas id="selfRegulationChart"></canvas>
            </div>
            <div class="normal-chart-container">
                <canvas id="extracurricularChart"></canvas>
            </div>
            <div class="normal-chart-container">
                <canvas id="internalAcademicChart"></canvas>
            </div>
            <div class="normal-chart-container">
                <canvas id="languageProcessingChart"></canvas>
            </div>
            <div class="normal-chart-container">
                <canvas id="engineeringThinkingChart"></canvas>
            </div>
            <div class="normal-chart-container">
                <canvas id="medicalAptitudeChart"></canvas>
            </div>
        </div>
        
        <!-- 4. 입시성향분석 - 교과형 vs 종합형, 서류형 vs 면접형 -->
        <h2>4. 입시성향분석 - 교과형 vs 종합형, 서류형 vs 면접형</h2>
        <div class="chart-container">
            <canvas id="quadrantChart"></canvas>
        </div>
        
        <!-- 5. 학업성취도 분석 -->
        <h2>5. 학업성취도 분석</h2>
        <div class="chart-container">
            <canvas id="academicChart"></canvas>
        </div>
        
        <!-- 6. 고교 추천 결과 -->
        <h2>6. 진학고교 추천</h2>
        <div class="school-recommendation-container" style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 30px;">
            <table class="scale-data-table" id="recommendationTable">
                <thead>
                    <tr>
                        <th>지망</th>
                        <th>추천 고등학교</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>1지망</strong></td>
                        <td id="firstChoice">분석 중...</td>
                    </tr>
                    <tr>
                        <td><strong>2지망</strong></td>
                        <td id="secondChoice">분석 중...</td>
                    </tr>
                    <tr>
                        <td><strong>3지망</strong></td>
                        <td id="thirdChoice">분석 중...</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- 추가 평가 정보 -->
            <div style="margin-top: 25px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px;">추천 근거</h3>
                <ul style="list-style-type: none; padding: 0; margin: 0;">
                    <li style="padding: 8px 0; border-bottom: 1px dotted #eee;">
                        <strong>합격가능성 평가:</strong> <span id="admissionPossibility">분석 중...</span>
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px dotted #eee;">
                        <strong>학업성취도 평가:</strong> <span id="academicEvaluation">분석 중...</span>
                    </li>
                    <li style="padding: 8px 0;">
                        <strong>대입전형 평가:</strong> <span id="admissionTypeEvaluation">분석 중...</span>
                    </li>
                </ul>
            </div>
            
            <p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                * 이 추천 결과는 학생의 적성과 학업 성취도를 바탕으로 한 참고용 정보입니다.
            </p>
        </div>
        
        <!-- 7. 대입전략 수립 -->
        <h2>7. 대입전략 수립</h2>
        <div class="university-strategy-container" style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 30px;">
            <table class="scale-data-table" id="strategyTable">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>추천 대입전략</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>1순위</strong></td>
                        <td id="firstStrategy">분석 중...</td>
                    </tr>
                    <tr>
                        <td><strong>2순위</strong></td>
                        <td id="secondStrategy">분석 중...</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- 대입전략 상세 내용 -->
            <div style="margin-top: 30px;">
                <div style="background-color: #f9f9f9; border-radius: 8px; padding: 20px;">
                    <h3 style="font-size: 16px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px;">교과 대비 전략</h3>
                    <p style="line-height: 1.6; margin: 0 0 10px 0;">
                        내면학업수행능력이 상위 43% 수준으로 장기적으로는 내신 성적의 안정화를 위해 학습 루틴을 고도화하고
                        중간/기말 시험 대비 학습 피드백을 학생부에 기록할 수 있도록 노력해야 합니다.
                    </p>
                    <p style="line-height: 1.6; margin: 0;">
                        수행평가를 통해 교과 내용의 탐구 깊이를 보강하고, 교과세특 상에 '문제해결력', '교과내용 재구성' 등의 키워드가 드러나도록 관리해야 합니다.
                    </p>
                </div>
                <div style="background-color: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <h3 style="font-size: 16px; margin: 0 0 15px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px;">학생부종합형 대비 전략</h3>
                    <p style="line-height: 1.6; margin: 0 0 10px 0;">
                        비교과수행능력이 상위 18% 수준으로 프로젝트형 탐구 활동 또는 교내외 발표 및 자율보고서에 참여를 통해 비교과 포트폴리오를 심화시켜야 하며,
                        수행평가에서 자신의 탐구과정을 상세히 기록해야합니다. 
                    </p>
                    <p style="line-height: 1.6; margin: 0;">
                        교과 연계 발표 주제 및 독서활동 기록을 풍부하게 채우고 탐구활동을 확장시킬 수 있도록 학기별 발표기회나 소논문 작성을 선제적으로 계획할 필요가 있습니다.
                    </p>
                </div>
            </div>
            
            <p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                * 이 대입전략은 학생의 고교적성과 입시성향, 학업 성취도를 바탕으로 한 참고용 정보입니다.
            </p>
        </div>
        
        <!-- 8. 전체 입시 로드맵 -->
        <h2>8. 전체 입시 로드맵</h2>
        <div class="admission-roadmap-container" style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 30px;">
            <div id="roadmapContainer">
                <!-- 로드맵이 이 곳에 렌더링됩니다 -->
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                * 이 입시 로드맵은 학생의 적성과 역량을 바탕으로 한 전체적인 입시 계획 참고 자료입니다.
            </p>
        </div>
        
        <!-- 9. 학업개선방안 -->
        <h2>9. 학업개선방안</h2>
        <div class="academic-improvement-container" style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 30px;">
            <div id="academicImprovementContainer">
                <!-- 학업개선방안이 이 곳에 렌더링됩니다 -->
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                * 취약 과목, 우선적으로 신경써야할 과목에 대한 조언 및 전략을 제시합니다.
            </p>
        </div>
        
        <!-- 10. 종합의견 -->
        <h2>10. 종합의견</h2>
        <div class="overall-assessment-container" style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 30px;">
            <div id="overallAssessmentContainer">
                <!-- 종합의견이 이 곳에 렌더링됩니다 -->
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                * 학생의 전체적인 성향과 역량을 종합적으로 평가한 의견입니다.
            </p>
        </div>
    </div>
    
    <script>
        // 기본 설정
        Chart.register(ChartDataLabels);
        
        // URL 파라미터 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        const studentName = urlParams.get('name');
        
        // DOM 요소
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const reportContentDiv = document.getElementById('report-content');
        
        // 메인 코드
        if (!studentId || !studentName) {
            window.location.href = 'index.html';
        } else {
            // 데이터 로드 시작 시 로딩 표시
            loadingDiv.style.display = 'block';
            reportContentDiv.style.display = 'none';
            
            // data.js의 getStudentData 함수 사용
            getStudentData(studentId, studentName)
                .then(studentData => {
                    // 학생 기본 정보 표시
                    document.getElementById('studentId').textContent = studentData.id;
                    document.getElementById('studentName').textContent = studentData.name;
                    document.getElementById('studentSchool').textContent = studentData.school;
                    document.getElementById('testDate').textContent = studentData.testDate;
                    
                    // UI 업데이트
                    loadingDiv.style.display = 'none';
                    reportContentDiv.style.display = 'block';
                    
                    // 차트 생성
                    createRadarChart(studentData);
                    createNormalDistCharts(studentData);
                    updateScaleTable(studentData);
                    createQuadrantChart(studentData);
                    createAcademicChart(studentData);
                    
                    // 고교 추천 결과 처리
                    const recommendations = getHighSchoolRecommendations(studentData);
                    const firstChoice = document.getElementById('firstChoice');
                    const secondChoice = document.getElementById('secondChoice');
                    const thirdChoice = document.getElementById('thirdChoice');
                    
                    firstChoice.textContent = recommendations[1] || '조건에 맞는 추천 없음';
                    secondChoice.textContent = recommendations[2] || '조건에 맞는 추천 없음';
                    thirdChoice.textContent = recommendations[3] || '조건에 맞는 추천 없음';
                    
                    // 추천 학교 텍스트 스타일 적용 (볼드체만 적용)
                    firstChoice.style.fontWeight = 'bold';
                    secondChoice.style.fontWeight = 'bold';
                    thirdChoice.style.fontWeight = 'bold';
                    
                    // 추가 평가 정보 채우기
                    // 1. 합격가능성 평가
                    const admissionPossibilityEl = document.getElementById('admissionPossibility');
                    admissionPossibilityEl.textContent = `B등급과목개수 ${studentData.bGradeCount}개로 지원 시 합격가능성이 있습니다.`;
                    
                    // 2. 학업성취도 평가 
                    const englishPercentile = calculatePercentile(studentData.academicData.english.zScore);
                    const mathPercentile = calculatePercentile(studentData.academicData.math.zScore);
                    const englishRank = (100 - englishPercentile).toFixed(1);
                    const mathRank = (100 - mathPercentile).toFixed(1);
                    
                    const academicEvaluationEl = document.getElementById('academicEvaluation');
                    // academicEvaluationEl.textContent = `학업성취도가 영어, 수학 각각 상위 ${englishRank}%, 상위 ${mathRank}%로 고등학교 입학 후, 성적관리에 유리합니다.`;
                    academicEvaluationEl.textContent = `학업성취도가 영어, 수학 각각 전체 응답자 중 상위 1%, 상위 1%로 고등학교 입학 후, 성적관리에 유리합니다.`;


                    // 3. 대입전형 평가
                    // quadrantData.x 값이 종합형(+)/교과형(-) 점수, y 값이 서류형(+)/면접형(-) 점수
                    const comprehensiveX = studentData.quadrantData.x;
                    const documentY = studentData.quadrantData.y;
                    
                    // 교과형과 종합형 중 더 낮은 점수를 가진 영역 파악 (x값이 음수면 교과형 중심, 양수면 종합형 중심)
                    const focusArea = comprehensiveX > 0 ? '비교과활동' : '교과학업';
                    
                    // 백분위 계산 (여기서는 -25~25 범위의 값을 0~100 백분위로 변환한다고 가정)
                    // 실제로는 더 복잡한 계산식이 필요할 수 있습니다
                    const comprehensivePercentile = ((comprehensiveX + 25) / 50 * 100).toFixed(1);
                    const documentPercentile = ((documentY + 25) / 50 * 100).toFixed(1);
                    
                    const admissionTypeEvaluationEl = document.getElementById('admissionTypeEvaluation');
                    admissionTypeEvaluationEl.textContent = `종합형 인재점수가 상위 ${comprehensivePercentile}%, 교과형 인재점수가 상위 ${(100-comprehensivePercentile).toFixed(1)}%로, ${focusArea}을 적극적으로 공략하는 것이 유리합니다.`;
                    
                    // 대입전략 결과 처리
                    const strategies = getUniversityStrategies(studentData);
                    const firstStrategy = document.getElementById('firstStrategy');
                    const secondStrategy = document.getElementById('secondStrategy');
                    
                    firstStrategy.textContent = strategies[1] || '조건에 맞는 추천 없음';
                    secondStrategy.textContent = strategies[2] || '조건에 맞는 추천 없음';
                    
                    // 전략 텍스트 스타일 적용 (볼드체)
                    firstStrategy.style.fontWeight = 'bold';
                    secondStrategy.style.fontWeight = 'bold';
                    
                    // 입시 로드맵 생성 및 렌더링
                    const roadmapData = generateAdmissionRoadmap(studentData);
                    renderAdmissionRoadmap('roadmapContainer', roadmapData);
                    
                    // 학업개선방안 생성 및 렌더링
                    const improvementData = generateAcademicImprovements(studentData);
                    renderAcademicImprovements('academicImprovementContainer', improvementData);
                    
                    // 종합의견 생성 및 렌더링
                    const assessmentData = generateOverallAssessment(studentData);
                    renderOverallAssessment('overallAssessmentContainer', assessmentData);
                    
                    console.log('학생 데이터 로드 완료: ', studentData.name);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    errorDiv.innerText = error.message || '학생 정보를 찾을 수 없습니다.';
                    console.error('데이터 로드 오류:', error);
                });
        }
        
        // 방사형 차트 생성 함수
        function createRadarChart(studentData) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            // 5점 만점 점수 사용
            const averageScores = SCALES.map(scale => studentData.scaleScores5[scale.key]);
            
            // 파스텔톤 색상 정의
            const pastelBlue = 'rgba(116, 185, 255, 0.5)';
            const pastelColors = [
                'rgba(116, 185, 255, 1)',    // 파스텔 블루
                'rgba(162, 222, 208, 1)',    // 파스텔 민트
                'rgba(153, 102, 255, 1)',    // 파스텔 퍼플
                'rgba(255, 205, 86, 1)',     // 파스텔 옐로우
                'rgba(255, 159, 64, 1)',     // 파스텔 오렌지
                'rgba(201, 203, 207, 1)'     // 파스텔 그레이
            ];
            
            // 모바일인지 확인
            const isMobile = window.innerWidth <= 768;
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: SCALES.map(scale => scale.name),
                    datasets: [{
                        label: '5점 만점 평균',
                        data: averageScores,
                        backgroundColor: pastelBlue,
                        borderColor: 'rgb(85, 165, 240)',
                        pointBackgroundColor: pastelColors,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1.5,
                        pointRadius: isMobile ? 4 : 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: { 
                                stepSize: 1,
                                color: 'rgba(0, 0, 0, 0.5)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                color: '#333333',
                                font: {
                                    size: isMobile ? 12 : 16,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '6척도 절대점수 프로파일',
                            color: '#333333',
                            font: { size: isMobile ? 14 : 18, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        datalabels: {
                            color: '#333333',
                            backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            borderRadius: 4,
                            formatter: (value) => value.toFixed(1),
                            font: { weight: 'bold', size: isMobile ? 10 : 12 }
                        }
                    }
                }
            });
        }
        
        // 정규분포 차트 생성
        function createNormalDistCharts(studentData) {
            SCALES.forEach(scale => {
                const chartId = scale.key + 'Chart';
                const ctx = document.getElementById(chartId).getContext('2d');
                const score = studentData.scaleScores[scale.key];
                const zScore = studentData.scaleZScores[scale.key]; // Z점수 직접 사용
                const percentile = calculatePercentile(zScore);
                
                const normalDistData = generateNormalDistributionData(NORMAL_DIST.mean, NORMAL_DIST.stdDev, NORMAL_DIST.minScore, NORMAL_DIST.maxScore);
                const studentAreaData = normalDistData.filter(point => point.x >= score);
                
                // 학생 위치 y값 계산
                const normalFactor = 1 / (NORMAL_DIST.stdDev * Math.sqrt(2 * Math.PI));
                const exponent = -Math.pow((score - NORMAL_DIST.mean) / NORMAL_DIST.stdDev, 2) / 2;
                const studentY = normalFactor * Math.exp(exponent);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: '정규분포',
                                data: normalDistData,
                                borderColor: 'rgba(100, 100, 100, 0.5)',
                                backgroundColor: 'rgba(100, 100, 100, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: '상위 영역',
                                data: studentAreaData,
                                borderColor: scale.color,
                                backgroundColor: scale.color.replace('0.7', '0.3'),
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: '학생 위치',
                                data: [{ x: score, y: studentY }],
                                backgroundColor: scale.color,
                                borderColor: scale.color,
                                pointRadius: 8,
                                pointHoverRadius: 10,
                                showLine: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'linear',
                                min: NORMAL_DIST.minScore,
                                max: NORMAL_DIST.maxScore,
                                title: { display: true, text: '점수', font: { weight: 'bold' } }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { display: false },
                                title: { display: true, text: '빈도', font: { weight: 'bold' } }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: scale.name,
                                font: { size: window.innerWidth <= 768 ? 14 : 16, weight: 'bold' }
                            },
                            subtitle: {
                                display: true,
                                text: `Z점수: ${zScore.toFixed(2)}, 백분위: ${percentile}%`,
                                font: { size: window.innerWidth <= 768 ? 10 : 12 }
                            },
                            datalabels: {
                                display: ctx => ctx.datasetIndex === 2,
                                color: '#000000',
                                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                                borderRadius: 4,
                                padding: window.innerWidth <= 768 ? 2 : 4,
                                font: { weight: 'bold', size: window.innerWidth <= 768 ? 9 : 11 },
                                formatter: () => `상위 ${(100 - percentile).toFixed(1)}%`
                            }
                        }
                    }
                });
            });
        }
        
        // 점수 테이블 업데이트
        function updateScaleTable(studentData) {
            const tableBody = document.getElementById('scaleTableBody');
            tableBody.innerHTML = '';
            
            SCALES.forEach(scale => {
                const score = studentData.scaleScores[scale.key];
                const averageScore = studentData.scaleScores5[scale.key]; // 5점 만점 점수 직접 사용
                const zScore = studentData.scaleZScores[scale.key]; // Z점수 직접 사용
                const percentile = calculatePercentile(zScore);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${scale.name}</td>
                    <td>${score}</td>
                    <td>${averageScore.toFixed(1)}</td>
                    <td>${zScore.toFixed(2)}</td>
                    <td>${percentile}%</td>
                    <td>상위 ${(100 - percentile).toFixed(1)}%</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 사분면 차트 생성
        function createQuadrantChart(studentData) {
            const ctx = document.getElementById('quadrantChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '학생 위치',
                            data: [{ x: studentData.quadrantData.x, y: studentData.quadrantData.y }],
                            backgroundColor: 'rgba(255, 99, 132, 1)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            pointRadius: 10,
                            pointHoverRadius: 12
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                scales: {
                    x: {
                        min: -25,
                        max: 25,
                        title: { 
                            display: true, 
                            text: '교과형(-) ⟷ 종합형(+)', 
                            font: { weight: 'bold' } 
                        },
                        grid: {
                            color: context => context.tick.value === 0 ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.1)',
                            lineWidth: context => context.tick.value === 0 ? 2 : 1
                        }
                    },
                    y: {
                        min: -25,
                        max: 25,
                        title: { 
                            display: true, 
                            text: '면접형(-) ⟷ 서류형(+)', 
                            font: { weight: 'bold' } 
                        },
                        grid: {
                            color: context => context.tick.value === 0 ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.1)',
                            lineWidth: context => context.tick.value === 0 ? 2 : 1
                        }
                    }
                },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '교과형-종합형 / 면접형-서류형 분석',
                            font: { size: 16, weight: 'bold' }
                        },
                        datalabels: {
                            display: true,
                            formatter: () => studentName,
                            font: { weight: 'bold' },
                            offset: 10,
                            anchor: 'center',
                            align: 'top'
                        }
                    }
                }
            });
        }
        
        // 학업성취도 차트 생성
        function createAcademicChart(studentData) {
            const ctx = document.getElementById('academicChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['영어', '수학'],
                    datasets: [
                        {
                            label: '점수',
                            data: [
                                studentData.academicData.english.score,
                                studentData.academicData.math.score
                            ],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgb(54, 162, 235)',
                                'rgb(255, 159, 64)'
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            title: { 
                                display: true, 
                                text: '점수', 
                                font: { weight: 'bold' } 
                            }
                        },
                        x: {
                            title: { 
                                display: true, 
                                text: '교과목', 
                                font: { weight: 'bold' } 
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '학업성취도 분석',
                            font: { size: 16, weight: 'bold' }
                        },
                        
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value, context) => {
                                const zScore = context.dataIndex === 0 ? 
                                    studentData.academicData.english.zScore : 
                                    studentData.academicData.math.zScore;
                                const percentile = calculatePercentile(zScore);
                                return `${value}점\n상위 ${(100 - percentile).toFixed(1)}%`;
                            },
                            font: { weight: 'bold', size: 12 }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
